/*! ContentDashboard 2016-03-30 */
window.global=window,function(a){var b={},c={};a.define=function(a,c){if(b[a])throw new Error('[ "'+a+"\" ] already exists, don't repeat the definition");b[a]=c},a.require=function(a){return c[a]?c[a]:(c[a]={},b[a](c[a]),c[a])}}(this),define("utility",function(a){"use strict";a.dateToFormatStr=function(a,b){var c=b&&b.dailyFormat||"MM/DD",d=b&&b.hourlyFormat||"MM/DD HH:mm",e=window.settings.timezone?global.moment(new Date(a)).tz(window.settings.timezone):global.moment(new Date(a)).utc(),f=b&&"day"===b.granularity;return e.format(f?c:d)},a.formatNumberStr=function(a){return a.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g,"$1,")},a.formatNumberPrecision=function(a,b){var c=Math.pow(10,b||3);return Math.round(a*c)/c},a.createUtcTime=function(a){return new Date(global.moment(new Date(a)).format("YYYY-MM-DDTHH:00")).getTime()},a.createLocalTime=function(a){return window.settings.timezone?new Date(global.moment(new Date(a)).tz(window.settings.timezone)).getTime():new Date(global.moment(new Date(a)).format("YYYY-MM-DDTHH:00")).getTime()},a.formatLabelStr=function(a,b){return b&&"string"==typeof b?b.replace("%s",a):a},a.getLocalTime=function(a){return new Date(1e3*parseInt(a)).toLocaleString().replace(/年|月/g,"-").replace(/日/g," ")}}),define("common/form",function(a){"use strict";function b(a,b,c){var d="object"!=typeof a?JSON.parse(a):a,e="";if(e+=b.toString()+"\r\n\n",c){var f="";for(var g in d[0])f+=g+",";f=f.slice(0,-1),e+=f+"\r\n"}for(var h=0;h<d.length;h++){var f="";for(var g in d[h])f+='"'+d[h][g]+'",';f.slice(0,f.length-1),e+=f+"\r\n"}if(""==e)return void alert("Invalid data");var i="csv_"+1*new Date;i+=b.toString().replace(/ /g,"_");var j="data:text/csv;charset=gb2312,\ufeff"+encodeURIComponent(e),k=document.createElement("a");k.href=j,k.setAttribute("style","visibility:hidden"),k.download=i+".csv",document.body.appendChild(k),k.click(),document.body.removeChild(k)}var c,d,e,f,g,h,i,j,k,l,m,n,o,p;c=function(){var a=$("form.dimensionForm",this),b=$(".start input.datex",a),c=$(".end input.datex",a),d=b.data("backdays")||7,e=c.data("backdays")||0,f=global.moment.utc().subtract(d,"days").format("YYYY/MM/DD 00:00"),k=global.moment.utc().subtract(e,"days").format("YYYY/MM/DD 24:00");$(".datex",a).datetimepicker({format:b.data("format"),minDate:window.settings["data-start-time"]||"2015-05-24",maxDate:global.moment.utc().add(90,"days").format("YYYY-MM-DD")}),b.data("DateTimePicker").date(f),c.data("DateTimePicker").date(k),$(".dimension-select",a).each(function(){var a=$(this),b=a.data("defaults").toString().split(",");a.select2({theme:"bootstrap",dropdownAutoWidth:!0,tags:!0,data:a.data("options"),matcher:function(a,b){return""===$.trim(a.term)?b:b.text.toLowerCase().indexOf(a.term.toLowerCase())>=0?b:null}}),b[0]&&a.select2("val",b)}),$("form.metricForm input").change(function(){h(i,j)}),$('input[name="granularity"]',a).change(function(){a.submit()}),$('input[name="dataSourceType"]',a).change(function(){a.submit()}),a.submit(function(a){a.preventDefault(),g(function(a,b){h(b,j)})}),a.submit(),$(".toggleCharts").click(function(){$(".chart-container").toggle()})},g=function(a){var b,c,f=$(".chart-table-container"),g=$("form.dimensionForm"),h=$("button[type=submit]",g),l=g.serializeArray(),m={};h.attr("disabled","disabled"),f.hide(),l.forEach(function(a){var b=a.name,c=a.value,d={type:"in",values:[]};b.indexOf("-not")<0&&_.indexOf(["start_time","end_time","granularity","dataSourceType"],b)<0&&(m[b]||(m[b]=d),m[b].values.push(c))}),l.forEach(function(a){var b;a.name.indexOf("-not")>=0&&"on"===a.value&&(b=a.name.replace("-not",""),m[b]&&(m[b].type="not"))}),j=d(g),c=e(),b={startTime:j.startTime,endTime:j.endTime,granularity:j.granularity,dataSourceType:j.dataSourceType,filter:m},c.length&&(b.groupBy=c,j.groupBy=c),j.postBody=b,Pace.track(function(){$.post(k,b).done(function(b){h.removeAttr("disabled"),200===b.status?(i=b.content,f.show(),a(null,i),$.notify(b.msg,{className:"success",autoHide:!0,autoHideDelay:1e3})):(a(b),$.notify(b.msg,{className:"error",autoHide:!0}))}).fail(function(b){h.removeAttr("disabled"),a(b),$.notify("Request Failed!",{className:"error",autoHide:!0})})})},e=function(){var a,b=$("form.groupbyForm"),c=[];return b.length&&(a=b.serializeArray(),a.forEach(function(a){c.push(a.value)})),c},d=function(a){var b={dataSourceType:$('input[name="dataSourceType"]:checked',a).val(),granularity:$('input[name="granularity"]:checked',a).val(),startTime:$('input[name="start_time"]',a).val(),endTime:$('input[name="end_time"]',a).val(),expids:$('select[name="expid"]',a).val()||["*"]};return b},f=function(){var a=$("form.metricForm"),b=a.serializeArray(),c=[];return b.forEach(function(b){var d=$('input[value="'+b.value+'"]',a);c.push({label:d.data("label"),name:b.value,template:d.data("template")})}),c},l=function(a){var b="",c=$("input[ value="+a+"]");return b=c?c.attr("data-label"):a},m=function(a){var b;return b=isNaN(1*a)?a:1*(1*a).toFixed(3)},n=function(a){function b(a,b,d){a.forEach(function(a){var e={},f=a.result||a.event||a;if(f){a.timestamp&&(e.Timestamp=global.moment(a.timestamp).format("MMMM Do YYYY, h:mm:ss a")),d&&(e.Timestamp=d),b&&(e["Data Key"]=b);for(var g in f)"title"==g?e.Title=m($(f[g]).attr("title")):"Date"!=g&&"timestamp"!=g&&("url"==g?e.Url=m(f[g]):e[l(g)]=m(f[g]))}c.push(e)})}var c=[];if(a instanceof Array&&a[0].result instanceof Array)b(a[0].result);else if(a instanceof Array&&a.length>0)b(a);else for(var d in a){var e=[{result:a[d].sum}],f=a[d].data;a[d].sum&&b(e,d,"Summary"),f&&b(f,d)}return c},o=function(a){var c=$('<button id="downloadExcel" class="btn-sm btn-success download_bt" href="javascript:void(0)">Download Excel</button>');$(".dataTables_length").after(c),c.click(function(){var c=n(a);b(JSON.stringify(c),"",!0)})},h=function(a,b){var c=f(),b=b||{};a&&(b.metrics=c,b.data=a,p(b),o(a))},a.init=function(a){$(document).ready(c),k=a.dataUrl||"",p=a.renderResult}}),define("chart_and_table/table",function(a){"use strict";var b,c,d,e=require("utility");b=function(a,b,c){var d;a[b.timestamp]||(a[b.timestamp]={},a[b.timestamp].timestamp=b.timestamp),a[b.timestamp].dataKey||(a[b.timestamp].dataKey=[]),a[b.timestamp].dataKey.push(c);for(d in b.result)a[b.timestamp][d]||(a[b.timestamp][d]=[]),a[b.timestamp][d].push(b.result[d])},c=function(a,c){var d,e={},f=[];c.forEach(function(c){a[c].data.forEach(function(a){b(e,a,c)}),b(e,{timestamp:0,result:a[c].sum},c)});for(d in e)"0"!==d&&f.push(e[d]);return f.push(e[0]),f=f.reverse()},d=function(a){var b,c=a.metrics,d=a.dataKeys.length,f=a.granularity;return b=[{data:"timestamp",title:"Timestamp",className:"dt-center",render:function(a){return a?'<div class="timestamp">'+e.dateToFormatStr(a,{granularity:f,dailyFormat:"YYYY-MM-DD, ddd",hourlyFormat:"YYYY-MM-DD HH:mm, ddd"})+"</div>":'<div class="timestamp summary">Summary</div>'}},{data:"dataKey",title:"Data Key",className:"dt-center",render:function(a){var b="";return a.forEach(function(a,c){b+=c?'<li class="exp expid">'+a+' <span class="font-blue">(Compare)</span></li>':d>1?'<li class="base">'+a+' <span class="font-blue">(Base)</span></li>':'<li class="base">'+a+"</li>"}),'<ul class="list-group">'+b+"</ul>"}}],c.forEach(function(a){b.push({data:a.name,title:a.label||a.name,className:"dt-center",render:function(b){var c="",b=b||[],d=b[0];return b.forEach(function(b,f){var g,h=e.formatNumberPrecision(100*(b-d)/d),i=e.formatLabelStr(e.formatNumberPrecision(b).toLocaleString(),a.template);g=h>0?"<p>"+i+'</p><p><strong class="font-red">↑'+h+"%</strong></p>":0>h?"<p>"+i+'</p><p><strong class="font-green">↓'+-h+"%</strong></p>":f?"<p>"+i+"</p><p><strong>0%</strong></p>":i,c+='<li class="'+(f?"exp":"base")+'">'+g+"</li>"}),'<ul class="list-group">'+c+"</ul>"}})}),b},a.draw=function(a){var b=c(a.data,a.dataKeys),e=d(a);$(".table-container").html('<table cellpadding="0" cellspacing="0" class="cell-border result-table"></table>'),$(".result-table").dataTable({data:b,pageLength:100,ordering:!1,columns:e})}}),define("chart_and_table/charts",function(a){"use strict";var b,c,d,e,f=require("utility");b=function(a,b,c){var d={};return b.forEach(function(b){var e=b.name;d[e]={},c.forEach(function(b){d[e][b]=[],(a[b].data||[]).forEach(function(a){var c=a.result[e];d[e][b].push([new Date(a.timestamp).getTime(),"NaN"===c?0:c])})})}),d},c=function(a,b,c,d,e){var g,h,i=a.points||splat(a),j=d.length,k=d&&d[0];return h=['<span style="font-size: 10px">'+f.dateToFormatStr(i[0].key,{granularity:c,dailyFormat:"ddd, YYYY-MM-DD",hourlyFormat:"ddd, YYYY-MM-DD HH:mm"})+"</span><br/>"],i.sort(function(a,b){return a.series.name===k&&(g=a.y),b.series.name===k&&(g=b.y),a.y>b.y?-1:a.y<b.y?1:0}),$.each(i,function(a,b){var c,d,i="",l=b.series,m=b.y;1===j?(l.name===k?i+="":(c=f.formatNumberPrecision(100*(g-m)/m),d="Yesterday"===l.name?"环比昨日":"同比上周",i+=c>0?'<span style="color:red"> ('+d+"增长"+c+"%)</span>":0>c?'<span style="color:green"> ('+d+"下降"+-c+"%)</span>":" 持平"),h.push('<span style="color:'+l.color+'">'+l.name+"</span>: <b>"+f.formatLabelStr(f.formatNumberPrecision(m).toLocaleString(),e)+"</b>"+i+"<br/>")):(l.name===k?i+=" (Base)":(c=f.formatNumberPrecision(100*(m-g)/g),i+=c>0?'<span style="color:red"> (↑'+c+"%)</span>":0>c?'<span style="color:green"> (↓'+-c+"%)</span>":" (=)"),h.push('<span style="color:'+l.color+'">'+l.name+"</span>: <b>"+f.formatLabelStr(f.formatNumberPrecision(m).toLocaleString(),e)+"</b>"+i+"<br/>"))}),h.push(b.options.footerFormat||""),h.join("")},d=function(a,b,d,e,g){var h,i=[],j=b.name,k=b.template,l=(b.label||b.name)+(k?" ("+f.formatLabelStr("",k)+")":""),m=d.granularity;for(h in a[j])i.push({name:h,data:a[j][h]});return{chart:{type:"spline",zoomType:"x"},colors:["#2f7ed8","#910000","#8bbc21","#492970","#f28f43","#0d233a","#77a1e5","#c42525","#a6c96a"],title:{text:l},credits:!1,legend:{backgroundColor:"white",borderColor:"#ddd",borderWidth:1,borderRadius:4,floating:!0,align:"left",verticalAlign:"top",layout:"vertical",y:-10,x:-10,style:{zIndex:99}},plotOptions:{series:{events:{legendItemClick:function(){var a=this.visible,b=this.name;_.each(e,function(c,d){var e=c.highcharts().series;e.forEach(function(c){d!==g&&c.name===b&&(a?c.hide():c.show())})})}}}},xAxis:{type:"datetime",labels:{formatter:function(){return f.dateToFormatStr(this.value,{granularity:"hour"})},step:1,style:{fontSize:"0.75em"}},tickAmount:8,min:f.createLocalTime(d.startTime),max:f.createLocalTime(d.endTime)},yAxis:[{title:{text:l},labels:{zIndex:6},startOnTick:!1}],series:i,tooltip:{formatter:function(a){return c(this,a,m,d.dataKeys,k)},shared:!0}}},e=function(a,b){var c=a.postBody,d=a.metrics||[];$.post(a.compareUrl||a.dataUrl+"?type=compare",c).done(function(a){if(200===a.status){var c,e=a.content;c=_.map(d,function(a){var b,c=a.name,d=[{name:"yesterday",label:"Yesterday"},{name:"lastweek",label:"Last Week"}],f=[];return d.forEach(function(a){b=[],(e[a.name].data||[]).forEach(function(d){var e=d.result[c],f="yesterday"===a.name?864e5:6048e5;b.push([new Date(d.timestamp).getTime()+f,"NaN"===e?0:e])}),f.push({name:a.label,visible:!1,data:b})}),f}),_.each(b,function(a,b){a.highcharts().addSeries(c[b][0]),a.highcharts().addSeries(c[b][1])})}else $.notify(a.msg,{className:"获取同比和环比数据失败！",autoHide:!0})}).fail(function(a){$.notify("获取同比和环比数据失败！",{className:"error",autoHide:!0})})},a.draw=function(a){{var c,f,g=$(".chart-container"),h=a.metrics||[],i=_.keys(a.data),j=b(a.data,h,i);a.postBody}a.dataKeys=i,g.html(""),c=_.map(h,function(){var a=$('<div class="col-sm-6 chart-box"><div class="result-chart"></div></div>').appendTo(g);return $(".result-chart",a)}),f=_.map(h,function(b,e){return d(j,b,a,c,e)}),_.each(c,function(a,b){a.highcharts(f[b])}),1===a.dataKeys.length&&e(a,c)}});var table=require("chart_and_table/table"),chart=require("chart_and_table/charts"),dataUrl="/data/chart_and_table/"+window.settings.pageType;require("common/form").init({dataUrl:dataUrl,renderResult:function(a){a.dataUrl=dataUrl,chart.draw(a),table.draw(a)}});